:toc:
:icons: font
:experimental:
:source-highlighter: pygments
:pygments-style: emacs

= IOT with docker

// variables
:VolumeName : bwp_elk_test_data01

== working with this project

=== initial

* https://code.visualstudio.com/download[VSC] with https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers[Remote-Containers]

* https://docs.docker.com/docker-for-windows/install-windows-home/[docker on Windows]

.https://www.ssh.com/ssh/keygen/[Copying the Public Key to the Server]
[source, bash]
----
ssh-copy-id -i ~/.ssh/id_rsa.pub user@host
----


=== basic commands

.freeze python requirements
[source, BASH]
----
pip freeze > docker/requirements.txt
----

.start docker container from #outside# the devContainer
[source, CMD]
----
docker-compose -f ./docker-compose.yml up --build --force-recreate -d
----

.stop docker container
[source, BASH]
----
docker-compose -f ./docker-compose.yml down
----

.load development Container in VSC
. kbd:[Ctrl+Shift+P] or kbd:[F1]
. type in : ``Remote-Containers: Reopen in Container``

[IMPORTANT]
The Extension https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers[Remote-Containers] is needed


.overview of environment variables in the project
[subs="attributes"]
----
include::.env[]
----


== docker remote deploying on raspberry

. install a OS on a SD-card

    e.g. UBUNTU SERVER 2.10 64bit

. install https://docs.docker.com/compose/install/#alternative-install-options[docker-compose] and https://docs.docker.com/engine/install/ubuntu/#install-using-the-repository[docker] on raspberry

+
[source, bash]
----
sudo pip install docker-compose
sudo apt install docker.io
----
+

+
[IMPORTANT]
docker-compose installed with pip. Other methods may lead to problems if using "remote" context because of causing a mismatch of OpenSSL versions.
+
. create docker context from Laptop/VSC and proof it
+
[source, bash]
----
docker context create remote --docker "host=ssh://ubuntu@192.168.178.7"

docker context ls

docker context use remote
----
+

[NOTE]
if there are still problems with docker, try to https://github.com/sindresorhus/guides/blob/main/docker-without-sudo.md[add ubuntu user to docker group or have access via SSH for docker daemon ].
+

[NOTE]
SSH key needs to be on the remote machine

+

.copy Project to remote machine / update Project files
[source, bash]
----
scp -r /workspaces/Elastic/ ubuntu@192.168.178.7:/home/ubuntu/ //<1>
rsync -r /workspaces/Elastic/ ubuntu@192.168.178.7:/home/ubuntu/Elastic //<2>
----
<1> copy
<2> update


== links

* https://medium.com/@TimvanBaarsen/how-to-run-an-elasticsearch-7-x-single-node-cluster-for-local-development-using-docker-compose-2b7ab73d8b82[Elastic single node]

* https://www.elastic.co/guide/en/elasticsearch/reference/7.11/docker.html[elasticsearch - docker]

* https://www.elastic.co/guide/en/kibana/current/docker.html[kibana - docker]

* https://docs.python.org/3/using/windows.html#the-microsoft-store-package[install python on Windows]

* https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.read_csv.html[pandas read CSV]

* https://github.com/h2oai/datatable[datable python - alternative to pandas] 

* https://elasticsearch-py.readthedocs.io/en/v7.11.0/api.html?highlight=update#elasticsearch[Elastic python API]

* https://kb.objectrocket.com/elasticsearch/how-to-use-python-helpers-to-bulk-load-data-into-an-elasticsearch-index[JSON bulk to Elastic with helpers]

* https://grafana.com/docs/grafana/latest/dashboards/json-model/[grafana dashboard JSON model]

* https://grafana.com/docs/grafana/latest/administration/provisioning/#dashboards[Provisioning Grafana]

* https://stackoverflow.com/questions/38546755/docker-compose-keep-container-running/56690087[keep empty ubuntu container running]

* https://stackoverflow.com/questions/38067511/start-an-existing-docker-ubuntu-container[ubuntu container: "take care"]

* https://docs.asciidoctor.org/asciidoc/latest/syntax-quick-reference/[asciidoc]

* https://stackoverflow.com/questions/56518032/windows-10-and-docker-container-logs-docker-logging-driver[see docker folder on Windows via WSL2]

* https://github.com/docker/awesome-compose[docker compose with examples]

* https://discuss.elastic.co/t/how-to-parse-load-json-file-or-txt-file-containing-json-to-logstash-using-grok/228246[logstash with elastic / parse json files]

* https://code.visualstudio.com/blogs/2019/10/31/inspecting-containers[inspecting-containers]

* https://www.cyon.ch/support/a/ssh-key-erstellen[SSH key]

* https://www.docker.com/blog/how-to-deploy-on-remote-docker-hosts-with-docker-compose/[docker remote deploying with context - tutorial]

* https://docs.docker.com/engine/install/linux-postinstall/[root for docker via SSH] 

* https://code.visualstudio.com/docs/remote/containers-advanced#_developing-inside-a-container-on-a-remote-docker-host[Developing inside a container on a remote Docker host]


== additional commands collection

.copy file via SSH
[source, cmd]
----
scp /path/to/file username@a:/path/to/destination
----

.get index from elastic
[source, bash]
----
curl -X GET "localhost:9200/_cat/indices/*?v=true&s=index&pretty"
----

.enter a container
[source, cmd]
----
docker exec -it ubuntu_server bash  
----

.remove Volume
[source, cmd, subs="attributes+"]
----
docker volume rm {VolumeName} # <1>
----
<1> remove of developing volume

.copy folder from inside Dev Container to remote machine
[source, bash]
----
scp -r /workspaces/Elastic/ ubuntu@192.168.178.7:/home/ubuntu/
----

.clear logs of a container
[source, bash]
----
docker run --rm -v /var/lib/docker:/var/lib/docker alpine sh -c "echo '' > $(docker inspect --format='{{.LogPath}}' CONTAINER_NAME)"
----

.clear folder with files
[source, bash]
----
sudo rm -r /path-to-folder
----

.start docker from SSH-Remote-Host (Pi) for production
[source, bash]
----
docker-compose -f docker-compose.yml -f docker-compose.arm.yml -f docker-compose.prod.yml -f docker-compose.local.yml up --build --force-recreate -d
----

.start docker from localhost (windows/devcontainer) on remote-host via SSH 
[source#hello, bash]
----
docker-compose -H ssh://ubuntu@192.168.178.7 -f docker-compose.yml -f docker-compose.arm.yml -f docker-compose.prod.yml up --build --force-recreate -d 
----

.add local bind-mounts. Makes Hot-deployment possible
[source, bash]
----
docker-compose -f ./docker-compose.yml -f ./docker-compose.local.yml up --build --force-recreate -d
----

== todo

